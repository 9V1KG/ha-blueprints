blueprint:
  name: Repeated Alert
  description: >
    # Repeated Alert
    
    
    This blueprint script makes repeated spoken alert announcements. It uses the script 
    `Spoken Announcement`, which is based on the blueprint `Spoken Notification` with 
    a selected announcement sound. The number of repititions can be set between 0 and 10.
    When zero is selected, announcement will be done only once.

  # source_url: https://github.com/9V1KG/...
  author: Klaus 9V1KG
  domain: script
  input:

    notify_service:
      name: Notify service name
      description: Select the name of your notification service, where the text notification should be sent.
      selector:
        text:
      default: notify.notify

    spoken_notify:
      name: Spoken Notification Script
      description: >
        Select the name of the script for spoken notifications generated by the blueprint 
        'spoken-notification.yaml'. It is necessary only, if you have renamed it, otherwise 
        the default 'Spoken Notification' should be ok.
      selector:
        entity:
          filter:
            - domain: script
      default: script.spoken_announcement
    
    repeat_times:
      name: How many times to repeat
      description: >
        Select the number, how many times the notification should be repeated.
      selector:
        number:
          min: 0
          max: 10
      default: 3

    alarm_reset:
      name: Alarm sound reset switch
      description: >
        Select a boolean input switch to reset a running repeating notification.
      selector:
        entity:
          filter:
            - domain: input_boolean

alias: Repeated notification

variables:
  act_repeat_times: !input repeat_times
  act_sn: !input spoken_notify
  act_speak_on: true

fields:
  message:
    selector:
      text:
    name: message
    required: true

sequence:
  - service: !input notify_service
    data:
      message: "{{ message }}"
      title: Alert
  - if:
    - condition: template
      value_template: "{{ act_speak_on }}"
    then:
      - if:
        - condition: template
          value_template: "{{ act_repeat_times > 0 }}"
        then:
          - service: input_boolean.turn_on
            target:
              entity_id: !input alarm_reset
          - repeat:
              until:
                - condition: or
                  conditions:
                    - condition: state
                      state: "off"
                      entity_id: !input alarm_reset
                    - condition: template
                      value_template: "{{repeat.index >= act_repeat_times}}"
              sequence:
                # Repeated Spoken Notification
                - service: "{{ act_sn }}"
                  data:
                    message: Attention!  {{ message }}.
          - service: "{{ act_sn }}"
            data:
              message: The Alert was reset.
        else:
          # Spoken Notification only once
          - service: "{{ act_sn }}"
            data:
              message: Attention!  {{ message }}.        
  - if:
      - condition: state
        entity_id: input_boolean.alarm_sound
        state: "on"
    then:
      - service: input_boolean.turn_off
        target:
          entity_id: !input alarm_reset

